// Prisma schema for Podcast EcoSpace Booking System
// MongoDB provider

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Booking model - stores all booking information
model Booking {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId

  // Customer Information
  customerName      String
  customerEmail     String
  customerPhone     String

  // Session Details
  selectedDate      DateTime
  selectedTime      String
  sessionDuration   Int      // in hours
  peopleCount       Int

  // Selected Options
  selectedSetup     String   // standard, video-2cam, premium
  selectedService   Json     // { id, name, price }
  additionalServices String[] // array of service IDs

  // Pricing
  basePrice         Float
  addonsTotal       Float
  totalPrice        Float

  // Status
  status            BookingStatus @default(PENDING)
  paymentStatus     PaymentStatus @default(UNPAID)
  paymentMethod     String?       // cash, card, apple_pay

  // Notes
  specialRequests   String?
  adminNotes        String?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  confirmedAt       DateTime?
  cancelledAt       DateTime?
  completedAt       DateTime?

  // Cancellation
  cancellationReason String?

  @@index([customerEmail])
  @@index([selectedDate])
  @@index([status])
  @@index([createdAt])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  PARTIAL
}

// Service Package model - stores available services/packages
model ServicePackage {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  name            String
  slug            String   @unique
  description     String
  price           Float
  originalPrice   Float?

  // Features included
  features        String[]
  notIncluded     String[]

  // Session details
  duration        Int      // default duration in hours
  maxPeople       Int      @default(5)

  // Display options
  isPopular       Boolean  @default(false)
  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)

  // Metadata
  category        String   // recording-only, podcast-editing, studio-rental, reels

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isActive])
  @@index([category])
}

// Add-on Service model
model AddOnService {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  name            String
  slug            String   @unique
  description     String
  price           Float
  icon            String   // lucide icon name

  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Blocked Time Slots - for unavailable dates/times
model BlockedSlot {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  date            DateTime
  timeSlots       String[] // specific times blocked, empty means whole day
  reason          String?

  createdAt       DateTime @default(now())

  @@index([date])
}

// Admin User model
model AdminUser {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  email           String   @unique
  passwordHash    String
  name            String
  role            AdminRole @default(STAFF)

  isActive        Boolean  @default(true)
  lastLoginAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  STAFF
}

// Analytics Event model - for tracking
model AnalyticsEvent {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  eventType       String   // page_view, booking_started, booking_completed, etc.
  eventData       Json?

  // Session info
  sessionId       String?
  userAgent       String?
  referrer        String?

  createdAt       DateTime @default(now())

  @@index([eventType])
  @@index([createdAt])
}

// Contact Form Submissions
model ContactSubmission {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  name            String
  email           String
  phone           String?
  message         String

  status          ContactStatus @default(NEW)
  adminNotes      String?

  createdAt       DateTime @default(now())
  respondedAt     DateTime?

  @@index([status])
  @@index([createdAt])
}

enum ContactStatus {
  NEW
  READ
  RESPONDED
  ARCHIVED
}

// Newsletter Subscribers
model NewsletterSubscriber {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  email           String   @unique
  isActive        Boolean  @default(true)

  subscribedAt    DateTime @default(now())
  unsubscribedAt  DateTime?
}

// Booking Audit Trail - tracks all changes to bookings
model BookingAudit {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  bookingId       String   @db.ObjectId
  action          String   // created, updated, status_changed, cancelled, confirmed
  changes         Json?    // what changed (before/after values)

  // Who made the change
  userId          String?  // admin user id if applicable
  userType        String   // customer, admin, system
  userName        String?

  // Additional context
  ipAddress       String?
  userAgent       String?
  reason          String?  // for cancellations, modifications

  createdAt       DateTime @default(now())

  @@index([bookingId])
  @@index([createdAt])
  @@index([action])
}

// Blog Category model
model BlogCategory {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  name            String   @unique
  slug            String   @unique
  description     String?
  icon            String?  // lucide icon name
  color           String?  // hex color

  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)
  postCount       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  posts           BlogPost[]

  @@index([isActive])
  @@index([sortOrder])
}

// Blog Tag model
model BlogTag {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  name            String   @unique
  slug            String   @unique
  usageCount      Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([usageCount])
}

// Blog Post model
model BlogPost {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  // Content
  title           String
  slug            String   @unique
  excerpt         String?
  content         String   // Rich text content
  featuredImage   String?

  // Metadata
  status          BlogStatus @default(DRAFT)
  isFeatured      Boolean  @default(false)
  readingTime     Int      @default(0) // minutes
  wordCount       Int      @default(0)

  // Engagement metrics
  viewCount       Int      @default(0)
  likeCount       Int      @default(0)
  shareCount      Int      @default(0)

  // Relations
  categoryId      String?  @db.ObjectId
  category        BlogCategory? @relation(fields: [categoryId], references: [id])
  tags            String[] // array of tag names

  // Author info (admin)
  authorId        String?
  authorName      String
  authorEmail     String?

  // SEO
  metaTitle       String?
  metaDescription String?
  keywords        String[]

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  @@index([status])
  @@index([categoryId])
  @@index([isFeatured])
  @@index([publishedAt])
  @@index([createdAt])
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Email Queue - for managing email sending with rate limiting
model EmailQueue {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  // Email details
  to              String
  subject         String
  templateType    String   // booking_confirmation, admin_booking, contact_admin, contact_ack, status_update, test
  templateData    Json     // data passed to template

  // Queue management
  status          EmailStatus @default(PENDING)
  priority        Int      @default(0) // higher = more urgent
  attempts        Int      @default(0)
  maxAttempts     Int      @default(3)

  // Tracking
  errorMessage    String?
  sentAt          DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  scheduledFor    DateTime @default(now())
  processedAt     DateTime?

  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
}

enum EmailStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

// Email Log - audit trail for all sent emails
model EmailLog {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId

  // Email details
  to              String
  subject         String
  templateType    String

  // Status
  status          String   // sent, failed
  messageId       String?  // from SMTP response
  errorMessage    String?

  // Metadata
  metadata        Json?    // additional context (booking id, contact id, etc.)

  // Timestamps
  createdAt       DateTime @default(now())

  @@index([to])
  @@index([templateType])
  @@index([status])
  @@index([createdAt])
}
